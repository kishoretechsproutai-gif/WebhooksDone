{% load static %}
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>SKU Predictions Across Months</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #eef2f7;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding: 40px;
        }
        h1 {
            text-align: center;
            margin-bottom: 40px;
            color: #2c3e50;
            font-weight: 700;
        }
        .selector-box {
            background: #fff;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            margin-bottom: 30px;
        }
        label {
            font-weight: 600;
            color: #495057;
        }
        .table-container {
            background: #fff;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 6px 18px rgba(0,0,0,0.1);
        }
        table {
            border-radius: 12px;
            overflow: hidden;
        }
        table th {
            background: #2c3e50;
            color: #fff;
            text-transform: uppercase;
            font-size: 0.9rem;
            letter-spacing: 0.5px;
        }
        table td {
            vertical-align: middle;
            font-size: 0.95rem;
        }
        .btn-primary {
            background: #1d72b8;
            border: none;
            transition: 0.3s;
        }
        .btn-primary:hover {
            background: #155d91;
        }
        .details-row {
            display: none;
            background-color: #f8f9fa;
        }
        .details-cell {
            text-align: left !important;
            padding: 18px;
            font-size: 0.95rem;
            color: #495057;
            border-left: 4px solid #1d72b8;
        }
        .no-data {
            text-align: center;
            padding: 30px;
            font-size: 1rem;
            color: #6c757d;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ðŸ“Š SKU Predictions Dashboard</h1>

        <!-- SKU Selector -->
        <div class="selector-box d-flex justify-content-center">
            <label for="skuSelect" class="me-3 mt-2">Select SKU:</label>
            <select id="skuSelect" class="form-select w-auto shadow-sm"></select>
        </div>

        <!-- Table -->
        <div class="table-container">
            <table class="table table-hover text-center align-middle">
                <thead>
                    <tr>
                        <th>Month</th>
                        <th>SKU</th>
                        <th>Predicted Sales</th>
                        <th>Actual Sales</th>
                        <th>Details</th>
                    </tr>
                </thead>
                <tbody id="predictionsTable">
                    <tr><td colspan="5" class="no-data">No data available</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // -------------------- Data from backend --------------------
        const predictionsData = {{ predictions_json|safe }};

        const skuSelect = document.getElementById("skuSelect");
        const tableBody = document.getElementById("predictionsTable");

        // Collect all unique SKUs
        const allSkus = new Set();
        for (const month in predictionsData) {
            predictionsData[month].forEach(item => allSkus.add(item.sku));
        }

        // Populate SKU dropdown
        allSkus.forEach(sku => {
            const option = document.createElement("option");
            option.value = sku;
            option.textContent = sku;
            skuSelect.appendChild(option);
        });

        // Render table rows for a given SKU across all months
        function renderTable(sku) {
            tableBody.innerHTML = "";
            let hasData = false;

            Object.entries(predictionsData).forEach(([month, items]) => {
                items.filter(item => item.sku === sku).forEach((item, index) => {
                    hasData = true;
                    const rowId = `details-${month}-${index}`;
                    const row = `
                        <tr>
                            <td>${month}</td>
                            <td>${item.sku}</td>
                            <td>${item.predicted_sales}</td>
                            <td>${item.actual_sales ?? '-'}</td>
                            <td>
                                <button class="btn btn-sm btn-primary shadow-sm" onclick="toggleDetails('${rowId}', this)">
                                    View Details
                                </button>
                            </td>
                        </tr>
                        <tr id="${rowId}" class="details-row">
                            <td colspan="5" class="details-cell">
                                <strong>Reason:</strong> ${item.reason || 'N/A'} <br>
                                <strong>Error Reason:</strong> ${item.error_reason || 'N/A'}
                            </td>
                        </tr>
                    `;
                    tableBody.insertAdjacentHTML("beforeend", row);
                });
            });

            if (!hasData) {
                tableBody.innerHTML = `<tr><td colspan="5" class="no-data">No predictions available for this SKU</td></tr>`;
            }
        }

        // Toggle details row + button text
        function toggleDetails(rowId, btn) {
            const row = document.getElementById(rowId);
            if (row.style.display === "none" || row.style.display === "") {
                row.style.display = "table-row";
                btn.textContent = "Hide Details";
            } else {
                row.style.display = "none";
                btn.textContent = "View Details";
            }
        }

        // Initial load
        if (allSkus.size > 0) {
            const firstSku = [...allSkus][0];
            skuSelect.value = firstSku;
            renderTable(firstSku);
        }

        // Change SKU
        skuSelect.addEventListener("change", function() {
            renderTable(this.value);
        });
    </script>
</body>
</html>
